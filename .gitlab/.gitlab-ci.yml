stages:
  - publish

publish:
  stage: publish
  image: node:18
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /^ci - update package version/'
      when: never
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: on_success
    - if: '$CI_COMMIT_TAG'
      when: on_success
  script:
    - npm ci
    - cp .gitlab/.npmrc .npmrc
    - YEAR=$(date +%Y)
    - MONTH=$(date +%-m)
    - YEAR_MONTH="${YEAR}.${MONTH}"
    - |
      # Get all versions for this month from GitLab registry
      VERSIONS=$(npm view @USER_GROUP/claude-setting-manager versions --json 2>/dev/null || echo "[]")
      PATCH=$(echo "$VERSIONS" | grep -c "\"${YEAR_MONTH}\.") || PATCH=0
      VERSION="${YEAR_MONTH}.${PATCH}"
    - echo "Generated CalVer version $VERSION"
    - npm version $VERSION --no-git-tag-version || echo "Version already set to $VERSION"
    - git config user.name ".gitlab-ci[bot]"
    - git config user.email ".gitlab-ci[bot]@.gitlab.com"
    - git add package.json package-lock.json || true
    - |
      if ! git diff --cached --quiet; then
        git commit -m "ci - update package version to $VERSION"
        git push https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:master
        echo "Version changes committed and pushed"
      else
        echo "No version changes to commit"
      fi
    - npm publish
    - echo "Published $VERSION successfully "